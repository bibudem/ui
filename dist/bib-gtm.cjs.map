{"version":3,"file":"bib-gtm.cjs","sources":["../src/components/bib-gtm/bib-gtm.js"],"sourcesContent":["import { css, LitElement, unsafeCSS } from 'lit'\nimport { addToGlobalBib } from '@/utils/bib.js'\nimport { ConsentTokens } from '../bib-consent/ConsentTokens.js'\nimport styles from './bib-gtm.scss?inline'\nimport { GTM_CONTAINER_ID } from './constants.js'\n\nfunction loadGtm(containerId) {\n  const gtmScriptId = 'bib-GTM-script'\n  if (document.querySelector(`script#${gtmScriptId}`)) {\n    return\n  }\n\n  var gtmScript = document.createElement('script')\n  gtmScript.id = gtmScriptId\n  gtmScript.async = true\n  gtmScript.src = `https://www.googletagmanager.com/gtm.js?id=${containerId}`\n\n  var firstScript = document.getElementsByTagName('script')[0]\n  firstScript.parentNode.insertBefore(gtmScript, firstScript)\n}\n\nexport class BibGtm extends LitElement {\n\n  static properties = {\n    containerId: {\n      type: String,\n      attribute: 'container-id'\n    },\n    hidden: {\n      type: Boolean\n    }\n  }\n\n  static styles = [\n    css`${unsafeCSS(styles)}`\n  ]\n\n  constructor() {\n    super()\n\n    this.hidden = true\n    this.containerId = GTM_CONTAINER_ID\n    this.#init()\n  }\n\n  #init() {\n    const containerId = this.containerId\n\n    setTimeout(() => {\n      const consentElem = document.querySelector('bib-consent')\n\n      if (consentElem) {\n        console.warn('bib-consent element found')\n\n        // TEMP\n        globalThis.nogtm = true\n\n        function consentListener(event) {\n          console.log(`[bib-consent] événement ${event.type}`, event.detail)\n\n          const consentData = event.detail\n\n          if (consentData !== null) {\n\n            loadGtm(containerId)\n\n            const { analytics_consent, ad_consent } = consentData\n\n            const gtmConsentData = {\n              ad_user_data: ad_consent,\n              ad_personalization: ad_consent,\n              ad_storage: ad_consent,\n              analytics_storage: analytics_consent\n            }\n\n            console.log('Updating GTM consent with', gtmConsentData)\n\n            gtag('consent', 'update', gtmConsentData)\n          }\n        }\n\n        const dataLayer = globalThis.dataLayer = globalThis.dataLayer || []\n        const gtag = globalThis.gtag = globalThis.gtag || function gtag() { dataLayer.push(arguments) }\n\n        const defaultConsent = new ConsentTokens(false)\n        console.log('defaultConsent: ', defaultConsent)\n\n        gtag('consent', 'default', defaultConsent.toGTM())\n        dataLayer.push({ 'gtm.start': new Date().getTime(), 'event': 'gtm.js' })\n\n        consentElem.addEventListener('bib:consent:ready', consentListener)\n        consentElem.addEventListener('bib:consent:update', consentListener)\n      } else {\n        console.warn('No bib-consent element found')\n      }\n\n    })\n  }\n}\n\nif (!window.customElements.get('bib-gtm')) {\n  window.customElements.define('bib-gtm', BibGtm)\n}\n\naddToGlobalBib('gtm', {})"],"names":["BibGtm","LitElement","constructor","super","this","_s_instances","hidden","containerId","GTM_CONTAINER_ID","WeakSet","e_fn","init","setTimeout","consentElem","document","querySelector","consentListener","event","console","log","type","detail","consentData","gtmScriptId","gtmScript","createElement","id","async","src","firstScript","getElementsByTagName","parentNode","insertBefore","analytics_consent","ad_consent","gtmConsentData","ad_user_data","ad_personalization","ad_storage","analytics_storage","gtag","warn","globalThis","nogtm","dataLayer","push","arguments","defaultConsent","ConsentTokens","toGTM","Date","getTime","addEventListener","static","String","attribute","Boolean","css","unsafeCSS","window","customElements","get","define","addToGlobalBib"],"mappings":"ydAqBO,MAAMA,UAAeC,EAAAA,EAgB1B,WAAAC,aACEC,UAjBGC,QAAAC,0GAmBHD,KAAKE,QAAAA,EACLF,KAAKG,YAAcC,EAAgBA,iBACnCJ,OAAAA,EAAAA,GAAAA,KAAAA,KACD,EAtBIC,EAAA,IAAAI,QAwBLC,EAAAC,WACE,MAAMJ,EAAcH,KAAKG,YAEzBK,YAAW,KACHC,MAAAA,EAAcC,SAASC,cAAc,eAE3C,GAAIF,EAAa,CAMNG,IAAAA,EAAT,SAAyBC,GACvBC,QAAQC,IAAI,2BAA2BF,EAAMG,OAAQH,EAAMI,QAE3D,MAAMC,EAAcL,EAAMI,OAE1B,GAAoB,OAAhBC,EAAsB,EAxDpC,SAAiBf,GACf,MAAMgB,EAAc,iBACpB,IAAIT,SAASC,cAAc,UAAUQ,KAArC,CAIIC,IAAAA,EAAYV,SAASW,cAAc,UACvCD,EAAUE,GAAKH,EACfC,EAAUG,OAAAA,EACVH,EAAUI,IAAM,8CAA8CrB,IAE9D,IAAIsB,EAAcf,SAASgB,qBAAqB,UAAU,GAC1DD,EAAYE,WAAWC,aAAaR,EAAWK,EAR9C,CASH,CAbA,CA0DoBtB,GAER,MAAM0B,kBAAEA,EAAiBC,WAAEA,GAAeZ,EAEpCa,EAAiB,CACrBC,aAAcF,EACdG,mBAAoBH,EACpBI,WAAYJ,EACZK,kBAAmBN,GAGrBf,QAAQC,IAAI,4BAA6BgB,GAEzCK,EAAK,UAAW,SAAUL,EAC3B,CACF,EA3BDjB,QAAQuB,KAAK,6BAGbC,WAAWC,OAAAA,EA0BX,MAAMC,EAAYF,WAAWE,UAAYF,WAAWE,WAAa,GAC3DJ,EAAOE,WAAWF,KAAOE,WAAWF,MAAQ,WAAkBI,EAAUC,KAAKC,UAAY,EAEzFC,EAAiB,IAAIC,EAAaA,eAAC,GACzC9B,QAAQC,IAAI,mBAAoB4B,GAEhCP,EAAK,UAAW,UAAWO,EAAeE,SAC1CL,EAAUC,KAAK,CAAE,aAAA,IAAiBK,MAAOC,UAAWlC,MAAS,WAE7DJ,EAAYuC,iBAAiB,oBAAqBpC,GAClDH,EAAYuC,iBAAiB,qBAAsBpC,EAC3D,MACgByB,QAAAA,KAAK,+BAAA,GAIlB,EA1EDY,EAFWrD,EAEXqD,aAAoB,CAClB9C,YAAa,CACXa,KAAMkC,OACNC,UAAW,gBAEbjD,OAAQ,CACNc,KAAMoC,WAIVH,EAZWrD,EAYK,SAAA,CACdyD,EAAAA,IAAMC,EAAAA,uDAkELC,OAAOC,eAAeC,IAAI,YAC7BF,OAAOC,eAAeE,OAAO,UAAW9D,GAG1C+D,EAAcA,eAAC,MAAO,CAAE"}