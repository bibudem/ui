{"version":3,"file":"bib-consent-server.js","sources":["../src/components/bib-consent/bib-consent-server.js"],"sourcesContent":["import { css, html, LitElement, unsafeCSS } from 'lit'\nimport { startListening } from 'postmessage-promise'\nimport { createRef, ref } from 'lit/directives/ref.js'\nimport { escapeStringRegexp } from '@/utils/url.js'\nimport { loggerFactory } from '@/utils/logger.js'\nimport getPreferenceStorage from './PreferenceStorage.js'\nimport styles from './bib-consent-server.scss?inline'\n\nexport class BibConsentServer extends LitElement {\n  #storage\n  #logger = loggerFactory('consent-server')\n\n  static properties = {\n    connected: {\n      type: Boolean,\n    },\n    debug: {\n      type: Boolean,\n      reflect: true\n    },\n    allowedOrigins: {\n      type: String,\n      attribute: 'allowed-origins',\n      converter: {\n        fromAttribute: (value) => value.split(/\\s+/).map(origin => origin.trim()),\n        toAttribute: (value) => value.join(' ')\n      }\n    }\n  }\n\n  static styles = [\n    css`${unsafeCSS(styles)}`\n  ]\n\n  /**\n   * Constructs a new `BibConsentServer` instance.\n   * \n   * The `BibConsentServer` is responsible for managing the consent preferences for the BIB application. It initializes the preference storage, starts listening for postMessage events, and provides methods for setting, getting, and resetting the user's consent preferences.\n   * \n   * The constructor sets the initial state of the `BibConsentServer` instance, including whether it is connected, the debug mode, a reference to a logger, and the allowed origins for postMessage events.\n   * \n   * @constructor\n   * @param {boolean} [connected=false] - Indicates whether the `BibConsentServer` is currently connected and listening for postMessage events.\n   * @param {boolean} [debug=false] - Enables debug logging if set to `true`.\n   * @param {string[]} [allowedOrigins=[]] - An array of allowed origin patterns for postMessage events.\n   */\n  constructor() {\n    super()\n    this.connected = false\n    this.debug = this.debug || false\n    this.loggerRef = createRef()\n    this.allowedOrigins = this.allowedOrigins || [] // Default: none\n    this.init()\n  }\n\n  /**\n   * Initializes the BibConsentServer instance.\n   * \n   * This method sets up the preference storage, starts listening for storage update events, and begins listening for postMessage events from allowed origins.\n   * \n   * The preference storage is initialized using the `getPreferenceStorage()` function, and a listener is added to the storage to log any updates to the preferences.\n   * \n   * The `startListening()` method is then called to begin listening for postMessage events and handle requests to set, get, and reset the user's consent preferences.\n   */\n  async init() {\n    this.#storage = await getPreferenceStorage()\n    this.#storage.listen(event => {\n      this.log('Storage updated with data', event.detail)\n    })\n    this.startListening()\n  }\n\n  log() {\n    if (this.debug) {\n      this.#logger(...arguments)\n      const msg = [...arguments].map(part => typeof part === 'string' ? part : JSON.stringify(part)).join(' ')\n      this.loggerRef.value.value += `${this.loggerRef.value.value === '' ? '' : '\\r'}${msg}`\n    }\n  }\n\n  /**\n   * Starts listening for postMessage events from allowed origins and handles requests to set, get, and reset the user's consent preferences.\n   * \n   * This method sets up a message listener that filters incoming messages based on the allowed origins specified in the `allowedOrigins` property. It then handles the following methods:\n   * \n   * - `setPreferences`: Sets the user's consent preferences in the preference storage.\n   * - `getPreferences`: Retrieves the user's consent preferences from the preference storage.\n   * - `resetPreferences`: Resets the user's consent preferences in the preference storage.\n   * - `ping`: Responds with \"pong\" to a ping request.\n   * \n   * The method logs the method call and the response data, if any, to the debug logger.\n   */\n  async startListening() {\n    const { postMessage, listenMessage } = await startListening({\n      eventFilter: event => {\n        const { origin } = event\n        const originIsAllowed = this.allowedOrigins.length > 0 && this.allowedOrigins.some(originPattern => {\n          const originRegex = new RegExp(`${escapeStringRegexp(originPattern)}`)\n          return originRegex.test(origin)\n        })\n\n        return originIsAllowed\n      }\n    })\n\n    this.connected = true\n    this.log('connected:', this.connected)\n\n    listenMessage(async (method, payload, response) => {\n\n      let responseData\n\n      switch (method) {\n        case 'setPreferences':\n          responseData = await this.#storage.setPreferences(payload)\n          break\n\n        case 'getPreferences':\n          responseData = await this.#storage.getPreferences()\n          break\n\n        case 'resetPreferences':\n          responseData = await this.#storage.resetPreferences()\n          break\n\n        case 'ping':\n          responseData = \"pong\"\n          break\n\n        default:\n          this.log(`Unknown method: ${method}. Payload:`, payload)\n          throw new Error(`Unknown method: ${method}`)\n      }\n\n      if (payload) {\n        this.log(`Method \\`${method}\\` called with payload:`, payload, 'response:', responseData)\n      } else {\n        this.log(`Method \\`${method}\\` called.`, 'response:', responseData)\n      }\n\n      response(responseData)\n\n    })\n  }\n\n  render() {\n    return html`\n      <h1>I am bib-consent-server</h1>\n      <div class=\"log-container\">\n        <textarea class=\"log\" ${ref(this.loggerRef)}></textarea>\n      </div>`\n  }\n}\n\nif (!window.customElements.get('bib-consent-server')) {\n  window.customElements.define('bib-consent-server', BibConsentServer)\n}"],"names":["BibConsentServer","LitElement","storage","super","logger","loggerFactory","static","this","connected","debug","loggerRef","createRef","allowedOrigins","init","getPreferenceStorage","listen","event","log","detail","startListening","arguments","msg","map","part","JSON","stringify","join","value","postMessage","listenMessage","eventFilter","origin","length","some","originPattern","RegExp","escapeStringRegexp","test","originIsAllowed","async","method","payload","response","responseData","setPreferences","getPreferences","resetPreferences","Error","render","html","ref","window","type","Boolean","reflect","String","attribute","converter","fromAttribute","split","trim","toAttribute","css","unsafeCSS","customElements","get","define"],"mappings":"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"}