/**
 * Librairie du system desing des Bibliothèques de l'Université de Montréal
 * @module @bibudem/ui
 * @version 1.3.1
 * @author Christian Rémillard <christian.remillard@umontreal.ca>
 * @license ISC
 * @see https://github.com/bibudem/ui
 */
function e(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function n(e,n,t){return Object.defineProperty(e,"prototype",{writable:!1}),e}function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var r="client_response",o="server_response",s={server:{receive:r,post:o},client:{receive:o,post:r}},i=["hand-shake","wave-hand",r,o],a=n((function n(r,o,a){var c=this;t(this,n),e(this,"receiveMessage",(function(e,n,t){if(e===s[c.type].receive){if(n&&c.messageResponse[n]){var r=c.messageResponse[n];delete c.messageResponse[n],r(t)}}else c.listener?c.listener(e,t,(function(e){c.messageProxy.request(s[c.type].post,n,e)})):console.warn("no message listener: ",e,t)})),e(this,"doPost",(function(e,n,t){var r=e.resolve,o=e.reject,s=e.eventId;c.messageResponse[s]=r;try{c.messageProxy.request(n,s,t)}catch(i){throw delete c.messageResponse[s],o(),i}})),e(this,"listenMessage",(function(e){c.listener=e})),e(this,"postMessage",(function(e,n){return i.indexOf(e)>=0?Promise.reject(new Error("".concat(e," is a protected key-method."))):new Promise((function(t,r){if(c.destroyed)r(new Error("message-channel had been destroyed!"));else{var o=null,s=Math.random().toString().substr(3,10);c.doPost({resolve:function(e){clearTimeout(o),t(e)},reject:r,eventId:s},e,n),o=setTimeout((function(){c.messageResponse&&delete c.messageResponse[s],r(new Error("postMessage timeout"))}),c.timeout||2e4)}}))})),e(this,"destroy",(function(){c.destroyed=!0,c.unListen&&(c.unListen(),c.unListen=null),c.listener=null,c.messageResponse=null,c.messageProxy&&(c.messageProxy.destroy(),c.messageProxy=null)})),this.type=r,this.messageProxy=o,this.listener=null,this.messageResponse={},this.timeout=a,this.unListen=this.messageProxy.listen(this.receiveMessage)})),c="postmessage-promise_client",l="postmessage-promise_server",u="identity_key",d={server:{key:l,accept:c},client:{key:c,accept:l}},f=n((function n(r,o,s){var i=this;t(this,n),e(this,"listen",(function(e){var n=i,t=function(t){if(("*"===n.origin||t.origin===n.origin)&&t.source===n.source&&t.data&&t.data[u]===d[n.type].accept&&t.data.channelId===n.channelId&&n.eventFilter(t)&&t.data.method){var r=t.data,o=r.eventId,s=r.method,i=r.payload;e(s,o,i)}};return window.addEventListener("message",t),function(){window.removeEventListener("message",t)}})),e(this,"request",(function(n,t,r){i.source&&!i.source.closed?i.source.postMessage(e(e(e(e(e({},u,d[i.type].key),"channelId",i.channelId),"eventId",t),"method",n),"payload",r),i.origin):console.error("source closed.")})),e(this,"destroy",(function(){i.type="",i.origin="",i.source=null,i.channelId="",i.eventFilter=null})),this.type=r;var a=o.origin,c=o.source,l=o.channelId;this.origin=a,this.source=c,this.channelId=l,this.eventFilter=s}));function p(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function v(n){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach((function(t){e(n,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(r,e))}))}return n}function h(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function g(n){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?h(Object(r),!0).forEach((function(t){e(n,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):h(Object(r)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(r,e))}))}return n}var m="identity_key";function y(e){var n=document.createElement("a");n.href=e;var t=n.protocol.length>4?n.protocol:window.location.protocol,r=n.host.length?"80"===n.port||"443"===n.port?n.hostname:n.host:window.location.host;return n.origin||"".concat(t,"//").concat(r)}var w={resolveOrigin:y,getIframeServer:function(e,n,t){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=void 0!==e?e:document.body,s=y(n),i=document.createElement("iframe");return i.name=t||"",i.classList.add.apply(i.classList,r),o.appendChild(i),i.src=n,{server:i.contentWindow||i.contentDocument.parentWindow,origin:s,frame:i}},getOpenedServer:function(e){for(var n,t=y(e),r=arguments.length,o=new Array(r>1?r-1:0),s=1;s<r;s++)o[s-1]=arguments[s];return{server:(n=window).open.apply(n,[e].concat(o)),origin:t}}};var b={exports:{}},I=b.exports=P,O=/^\[object (.*)\]$/;
/*!
 * type-detect
 * Copyright(c) 2013 jake luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Primary Exports
 */function P(e){var n=Object.prototype.toString.call(e).match(O)[1].toLowerCase();return"function"==typeof Promise&&e instanceof Promise?"promise":null===e?"null":void 0===e?"undefined":n}function j(){if(!(this instanceof j))return new j;this.tests={}}I.Library=j,j.prototype.of=P,j.prototype.define=function(e,n){return 1===arguments.length?this.tests[e]:(this.tests[e]=n,this)},j.prototype.test=function(e,n){if(n===P(e))return!0;var t=this.tests[n];if(t&&"regexp"===P(t))return t.test(e);if(t&&"function"===P(t))return t(e);throw new ReferenceError('Type test "'+n+'" not defined or invalid.')};var k=b.exports;const M=(E=function(e){if("string"!==k(e))return!!e;var n;switch(e.toLowerCase()){case"false":case"0":case"undefined":case"null":case"":case"n":case"no":case"off":n=!1;break;default:n=!0}return n})&&E.__esModule&&Object.prototype.hasOwnProperty.call(E,"default")?E.default:E;var E;exports.callServer=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)throw new Error("serverObject is null");var t=e.server,r=e.origin,o=n.eventFilter,s=void 0===o?function(){return!0}:o,i=n.timeout,c=void 0===i?2e4:i,l=n.clientInfo,u=void 0===l?{}:l,d=n.onDestroy,p=Math.random().toString().substr(3,10),h={source:t,origin:r,channelId:p};return new Promise((function(e,n){if(t&&!t.closed){var r=new f("client",h,s);(o=h,i=r,l=c,p=u,new Promise((function(e,n){var t=o.source,r=o.origin,s=o.channelId,a=Number(Math.random().toString().substr(3,10)),c=null,u=new Date,d=null;d=i.listen((function(n,o){var l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("hand-shake"===n){var u=l||{},f=u.SYN,v=u.ACK,h=u.seqnumber,g=u.acknumber;1===f&&1===v&&g===a+1&&(clearInterval(c),d&&d(),i.request("hand-shake","hand-shake-event",{clientInfo:p,ACK:1,seqnumber:a+1,acknumber:h+1}),e({server:t,origin:r,channelId:s,serverInfo:l.serverInfo,clientInfo:p}))}})),c=setInterval((function(){if(!t||t.closed)throw clearInterval(c),d&&d(),n(new Error("server closed.")),new Error("server closed.");if(l&&new Date-u>l)throw clearInterval(c),d&&d(),n(new Error("connect timeout.")),new Error("connect timeout.");i.request("hand-shake","hand-shake-event",{clientInfo:p,SYN:1,ACK:0,seqnumber:a})}),100)}))).then((function(n){(function(e,n,t){var r=e.server,o=e.serverInfo,s=void 0===o?{}:o,i=e.channelId,c=new a("client",n,t),l=function(){c&&(c.destroy(),c=null),e.destroy&&e.destroy()},u=null;return u=setInterval((function(){r&&!r.closed||(console.info("server closed."),clearInterval(u),l())}),2e3),{run:function(e){e({channelId:i,serverInfo:s,postMessage:function(){var e;return c?(e=c).postMessage.apply(e,arguments):Promise.reject()},listenMessage:function(){var e;c&&(e=c).listenMessage.apply(e,arguments)},destroy:l})}}})(v(v({},n),{},{destroy:function(){r=null,d&&d(n.serverInfo,n)}}),r,c).run(e)})).catch((function(e){n(e)}))}else n(new Error("server closed"));var o,i,l,p}))},exports.hasBooleanParam=function(e,n){const t=(e="string"==typeof e?new URL(e,location):e).searchParams.get(n);return null!==t&&(""===t||M(t))},exports.patternMatchesOrigin=function(e,n){const t=e.replace(/[.]/g,"\\$&").replace(/-/g,"\\x2d").replace(/[*]/g,".*");return new RegExp(`^${t}$`,"u").test(n)},exports.startListening=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=n.eventFilter,r=void 0===t?function(){return!0}:t,o=n.timeout,s=void 0===o?2e4:o,i=n.serverInfo,c=void 0===i?{}:i,l=n.onDestroy;return new Promise((function(n){var t,o;(t=r,o=c,new Promise((function(n){var r="syn",s=Number(Math.random().toString().substr(3,10)),i=-1,a=null,c=5;window.addEventListener("message",(function l(u){if(u.data&&"postmessage-promise_client"===u.data[m]&&u.data.channelId&&u.data.method&&"hand-shake"===u.data.method&&t(u)){var d=u.data.payload||{},f=d.SYN,p=d.ACK,v=d.seqnumber,h=d.acknumber;if(1===f&&0===p){if("syn"!==r)return;i=v,r="ack";var g=function(){if(!u.source||u.source.closed)return console.info("client closed and reset to listening."),r="syn",clearTimeout(a),a=null,c=5,s=Number(Math.random().toString().substr(3,10)),i=-1,!1;try{u.source.postMessage(e(e(e(e({},m,"postmessage-promise_server"),"channelId",u.data.channelId),"method","hand-shake"),"payload",{serverInfo:o,acknumber:v+1,SYN:1,ACK:1,seqnumber:s}),u.origin)}catch(E){return console.error(E),!0}return!0};if(!g())return;a||(a=setTimeout((function e(){c>0?"ack"===r&&(c-=1,g()&&(a=setTimeout(e,1e3))):(console.info("server three-way hand shake timeout and reset to listening."),r="syn",clearTimeout(a),a=null,c=5,s=Number(Math.random().toString().substr(3,10)),i=-1)}),1e3))}else if("ack"===r&&1===p&&v===i+1&&h===s+1){r="finish",clearTimeout(a),a=null,window.removeEventListener("message",l);var y=u.data.payload,w=void 0===y?{}:y;n({client:u.source,origin:u.origin,channelId:u.data.channelId,serverInfo:o,clientInfo:w.clientInfo})}}}))}))).then((function(e){(function(e,n,t){var r=e.origin,o=e.client,s=e.channelId,i=e.clientInfo,c=void 0===i?{}:i,l=new f("server",{origin:r,source:o,channelId:s},n),u=new a("server",l,t),d=function(){u&&(u.destroy(),u=null),l=null,e.destroy&&e.destroy()},p=null;return p=setInterval((function(){o&&!o.closed||(console.info("client closed."),clearInterval(p),d())}),2e3),{run:function(e){e({channelId:s,clientInfo:c,postMessage:function(){var e;return u?(e=u).postMessage.apply(e,arguments):Promise.reject()},listenMessage:function(){var e;u&&(e=u).listenMessage.apply(e,arguments)},destroy:d})}}})(g(g({},e),{},{destroy:function(){l&&l(e.clientInfo,e)}}),r,s).run(n)}))}))},exports.stringIsUrl=function(e){try{return new URL(e,location),!0}catch{return!1}},exports.utils=w;
//# sourceMappingURL=url-y47v7naU.cjs.map
