{"version":3,"file":"bib-avis.cjs","sources":["../src/components/bib-avis/bib-avis.js","../src/icons/close_FILL0_wght400_GRAD0_opsz24.svg?raw","../src/utils/dom.js"],"sourcesContent":["import { Task } from '@lit/task'\nimport { LitElement, html, css, unsafeCSS } from 'lit'\nimport { unsafeHTML } from 'lit/directives/unsafe-html.js'\nimport { openDB } from 'idb'\nimport { nodeIsEmpty } from '@/utils/dom.js'\nimport { addToGlobalBib } from '@/utils/bib.js'\nimport { name as PKG_NAME } from '../../../package.json'\nimport closeIcon from '../../icons/close_FILL0_wght400_GRAD0_opsz24.svg?raw'\nimport bibAvisStyles from './bib-avis.scss?inline'\n\nconst DB_VERSION = 1\nconst STORE_NAME = 'avis'\n\nasync function hash(obj) {\n  const utf8 = new TextEncoder().encode(JSON.stringify(obj))\n  const hashBuffer = await crypto.subtle.digest('SHA-256', utf8)\n  const hashArray = Array.from(new Uint8Array(hashBuffer))\n  const hashHex = hashArray\n    .map((bytes) => bytes.toString(16).padStart(2, '0'))\n    .join('')\n  return hashHex\n}\n\n/**\n * Un avis\n * Affiche un avis\n */\nexport class BibAvis extends LitElement {\n  static properties = {\n    service: {\n      type: String\n    },\n    contexte: {\n      type: String,\n      default: 'site-web'\n    },\n    niveau: {\n      type: String\n    },\n    boutonFermer: {\n      type: Boolean,\n      attribute: 'bouton-fermer'\n    },\n    message: {\n      state: true\n    }\n  }\n\n  static styles = [\n    css`${unsafeCSS(bibAvisStyles)}`,\n    css`\n    `\n  ]\n\n  #avis\n  #db\n\n  constructor() {\n    super()\n\n    this.#avis = null\n    this.service = 'https://avis.bib.umontreal.ca'\n    this.contexte = 'site-web-dev'\n    this.niveau = 'important'\n    this.boutonFermer = false\n  }\n\n  #getAvis() {\n    return new Task(this, {\n      task: async ([service, contexte, niveau], { signal }) => {\n\n        const doGetAvis = new Promise(async (resolve, reject) => {\n          if (!nodeIsEmpty(this)) {\n            return resolve({ isLocal: true, message: this.innerHTML.split(/<!--\\?lit\\$\\d+\\$-->/).join('') })\n          }\n\n          const url = new URL(`${contexte}/${niveau}`, service)\n          const response = await fetch(url, {\n            headers: {\n              \"Accept\": \"application/json\",\n            },\n            signal\n          })\n\n          if (!response.ok) {\n            return reject(new Error(response.status))\n          }\n\n          const { message } = await response.json()\n\n          resolve({ isLocal: false, message })\n        })\n\n        try {\n          const data = await doGetAvis\n          await this.#processAvis(data)\n        } catch (error) {\n          console.error('[#getAvis] An error occured: %o', error)\n        }\n\n        return data\n      },\n      args: () => [this.service, this.contexte, this.niveau]\n    })\n  }\n\n  async #processAvis(avis) {\n    if (!avis.message) {\n      this.setMessage(null)\n      return\n    }\n\n    if (!('indexedDB' in window)) {\n      this.setMessage(avis.message)\n      return\n    }\n\n    const db = this.#db = await openDB(PKG_NAME, DB_VERSION, {\n      upgrade(db) {\n        // Checks if the object store exists:\n        if (!db.objectStoreNames.contains(STORE_NAME)) {\n          db.createObjectStore(STORE_NAME)\n        }\n      }\n    })\n\n    try {\n      const id = await hash(avis)\n      const storedAvis = await db.get(STORE_NAME, id)\n      if (storedAvis) {\n        if (!storedAvis.hidden) {\n          // Delete old entries\n          await db.delete(STORE_NAME, id)\n          this.#show(storedAvis)\n        }\n      } else {\n        this.#show(avis)\n      }\n    } catch (error) {\n      console.error('Something went wrong with indexedDB: %o', error)\n      this.setMessage(avis.message)\n    }\n  }\n\n  async #show(avis) {\n\n    const canceled = !this.dispatchEvent(new CustomEvent('bib:show', { bubbles: true, cancelable: true }))\n\n    if (canceled) {\n      return\n    }\n\n    this.setMessage(avis)\n\n    if (this.#db) {\n      const id = await hash(avis)\n      await this.#db.put(STORE_NAME, { ...avis, hidden: false }, id)\n    }\n  }\n\n  async #hide() {\n\n    const canceled = !this.dispatchEvent(new CustomEvent('bib:hide', { bubbles: true, cancelable: true }))\n\n    if (canceled) {\n      return\n    }\n\n    const id = await hash(this.#avis)\n    await this.#db.put(STORE_NAME, { ...this.#avis, hidden: true }, id)\n    this.#avis = null\n    this.requestUpdate()\n  }\n\n  connectedCallback() {\n    super.connectedCallback()\n    this.#getAvis()\n  }\n\n  #onBtnFermerClick() {\n    this.#hide()\n  }\n\n  _renderBoutonFermer() {\n    return this.boutonFermer ? html`<button class=\"btn-close\" aria-label=\"Fermer\" @click=\"${this.#onBtnFermerClick}\">${unsafeHTML(closeIcon)}</button>` : null\n  }\n\n  _avisTask = new Task(this, {\n    task: async ([service, contexte, niveau], { signal }) => {\n      const url = new URL(`${contexte}/${niveau}`, service)\n      const response = await fetch(url, {\n        headers: {\n          \"Accept\": \"application/json\",\n          // 'Content-Type': 'application/x-www-form-urlencoded',\n        },\n        signal\n      })\n      if (!response.ok) {\n        throw new Error(response.status)\n      }\n      return response.json()\n    },\n    args: () => [this.service, this.contexte, this.niveau]\n  })\n\n  render() {\n    return this.#avis?.message ? html`<aside class=\"container\"><div class=\"inner\"><div class=\"message\">${unsafeHTML(this.#avis.message)}</div>${this._renderBoutonFermer()}</div></aside>` : null\n  }\n\n  setMessage(message) {\n    this.#avis = typeof message === 'string' ? { message, isLocal: true } : message\n  }\n}\n\nif (!window.customElements.get('bib-avis')) {\n  window.customElements.define('bib-avis', BibAvis)\n}\n\naddToGlobalBib('avis', {})","export default \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" height=\\\"24\\\" viewBox=\\\"0 -960 960 960\\\" width=\\\"24\\\"><path d=\\\"M480-424 284-228q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536-480l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480-424Z\\\"/></svg>\"","export function nodeIsEmpty(node) {\n  return node.textContent.trim() === \"\"\n}"],"names":["STORE_NAME","async","hash","obj","utf8","TextEncoder","encode","JSON","stringify","hashBuffer","crypto","subtle","digest","Array","from","Uint8Array","map","bytes","toString","padStart","join","BibAvis","LitElement","constructor","super","__privateAdd","this","_c_instances","avis","db","_avisTask","Task","h","task","service","contexte","niveau","signal","i","url","URL","response","fetch","headers","Accept","ok","Error","status","json","args","boutonFermer","connectedCallback","_renderBoutonFermer","html","x","unsafeHTML","render","message","setMessage","isLocal","WeakSet","s_fn","getAvis","doGetAvis","Promise","resolve","reject","textContent","trim","innerHTML","split","c","data","processAvis","error","i_fn","window","openDB","PKG_NAME","name","upgrade","objectStoreNames","contains","createObjectStore","id","storedAvis","get","hidden","delete","show","console","dispatchEvent","CustomEvent","bubbles","cancelable","put","hide","requestUpdate","o_fn","onBtnFermerClick","static","type","String","default","Boolean","attribute","state","css","unsafeCSS","customElements","define","addToGlobalBib"],"mappings":"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"}