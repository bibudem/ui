{"version":3,"file":"bib-gtm.js","sources":["../src/components/bib-gtm/bib-gtm.js"],"sourcesContent":["import { css, LitElement, unsafeCSS } from 'lit'\r\nimport { addToGlobalBib } from '@/utils/bib.js'\r\nimport { ConsentTokens } from '../bib-consent/ConsentTokens.js'\r\nimport styles from './bib-gtm.scss?inline'\r\nimport { GTM_CONTAINER_ID } from './constants.js'\r\n\r\nfunction loadGtm(containerId) {\r\n  const gtmScriptId = 'bib-GTM-script'\r\n  if (document.querySelector(`script#${gtmScriptId}`)) {\r\n    return\r\n  }\r\n\r\n  var gtmScript = document.createElement('script')\r\n  gtmScript.id = gtmScriptId\r\n  gtmScript.async = true\r\n  gtmScript.src = `https://www.googletagmanager.com/gtm.js?id=${containerId}`\r\n\r\n  var firstScript = document.getElementsByTagName('script')[0]\r\n  firstScript.parentNode.insertBefore(gtmScript, firstScript)\r\n}\r\n\r\nexport class BibGtm extends LitElement {\r\n\r\n  static properties = {\r\n    containerId: {\r\n      type: String,\r\n      attribute: 'container-id'\r\n    },\r\n    hidden: {\r\n      type: Boolean\r\n    }\r\n  }\r\n\r\n  static styles = [\r\n    css`${unsafeCSS(styles)}`\r\n  ]\r\n\r\n  constructor() {\r\n    super()\r\n\r\n    this.hidden = true\r\n    this.containerId = GTM_CONTAINER_ID\r\n    this.#init()\r\n  }\r\n\r\n  #init() {\r\n    const containerId = this.containerId\r\n\r\n    setTimeout(() => {\r\n      const consentElem = document.querySelector('bib-consent')\r\n\r\n      if (consentElem) {\r\n        // console.warn('bib-consent element found')\r\n\r\n        function consentListener(event) {\r\n          // console.log(`[bib-consent] événement ${event.type}`, event.detail)\r\n\r\n          const consentData = event.detail\r\n\r\n          if (consentData !== null) {\r\n            // console.log('[bib-consent] tokens:', Object.entries(consentData).map(entry => entry.join(': ')).join(', '))\r\n\r\n            loadGtm(containerId)\r\n\r\n            const { analytics_consent, ad_consent } = consentData\r\n\r\n            const gtmConsentData = {\r\n              ad_user_data: ad_consent,\r\n              ad_personalization: ad_consent,\r\n              ad_storage: ad_consent,\r\n              analytics_storage: analytics_consent\r\n            }\r\n\r\n            // console.log('Updating GTM consent with', gtmConsentData)\r\n\r\n            gtag('consent', 'update', gtmConsentData)\r\n          }\r\n        }\r\n\r\n        const dataLayer = globalThis.dataLayer = globalThis.dataLayer || []\r\n        const gtag = globalThis.gtag = globalThis.gtag || function gtag() { dataLayer.push(arguments) }\r\n\r\n        const defaultConsent = new ConsentTokens(false)\r\n        // console.log('defaultConsent: ', defaultConsent)\r\n\r\n        gtag('consent', 'default', defaultConsent.toGTM())\r\n        dataLayer.push({ 'gtm.start': new Date().getTime(), 'event': 'gtm.js' })\r\n\r\n        consentElem.addEventListener('bib:consent:ready', consentListener)\r\n        consentElem.addEventListener('bib:consent:update', consentListener)\r\n      } else {\r\n        console.warn('No bib-consent element found')\r\n      }\r\n\r\n    })\r\n  }\r\n}\r\n\r\nif (!window.customElements.get('bib-gtm')) {\r\n  window.customElements.define('bib-gtm', BibGtm)\r\n}\r\n\r\naddToGlobalBib('gtm', {})"],"names":["BibGtm","LitElement","static","super","this","hidden","containerId","GTM_CONTAINER_ID","window","init","setTimeout","consentElem","document","querySelector","consentListener","event","consentData","detail","gtmScriptId","gtmScript","createElement","id","async","src","firstScript","getElementsByTagName","parentNode","insertBefore","analytics_consent","ad_consent","gtag","ad_user_data","ad_personalization","ad_storage","analytics_storage","dataLayer","globalThis","push","arguments","defaultConsent","ConsentTokens","toGTM","Date","getTime","addEventListener","console","warn","type","String","attribute","Boolean","css","unsafeCSS","customElements","get","define","addToGlobalBib"],"mappings":";;;;;;;;;;;;;;AAqBO,MAAMA,UAAeC,EAE1BC;AAAAA,EAcA;AACEC,UAEAC;AAnBG;AAmBHA,SAAKC,eACLD,KAAKE,cAAcC,GACnBH,sBAAAA,oBAAAA;AAAAA,EACD;AAuDEI;AA7EE;AAwBL,OAAAC;AACE,QAAMH,KAAcF,KAAKE;AAEzBI,aAAW;AACT,UAAMC,KAAcC,SAASC,cAAc,aAAA;AAE3C,QAAIF,IAAa;AAGf,UAASG,KAAT,SAAyBC,IAAAA;AAGvB,cAAMC,KAAcD,GAAME;AAE1B,YAAoB,SAAhBD,IAAsB;AArDpC,WAAA,SAAiBV;AACf,kBAAMY,KAAc;AACpB,gBAAIN,CAAAA,SAASC,cAAc,UAAUK,EAAAA,EAAAA,GAArC;AAIA,kBAAIC,KAAYP,SAASQ,cAAc,QAAA;AACvCD,cAAAA,GAAUE,KAAKH,IACfC,GAAUG,QAAQ,MAClBH,GAAUI,MAAM,8CAA8CjB,EAAAA;AAE9D,kBAAIkB,KAAcZ,SAASa,qBAAqB,QAAU,EAAA,CAAA;AAC1DD,cAAAA,GAAYE,WAAWC,aAAaR,IAAWK,EAR9C;AAAA,YAAA;AAAA,UASH,EA2CoBlB,EAAAA;AAER,kBAAMsB,mBAAEA,IAAiBC,YAAEA,GAAeb,IAAAA;AAW1Cc,UAAAA,GAAK,WAAW,UATO,EACrBC,cAAcF,IACdG,oBAAoBH,IACpBI,YAAYJ,IACZK,mBAAmBN,GAAAA,CAAAA;AAAAA,QAMtB;AAAA,MACF;AAED,YAAMO,KAAYC,WAAWD,YAAYC,WAAWD,aAAa,CAAA,GAC3DL,KAAOM,WAAWN,OAAOM,WAAWN,QAAQ,WAAkBK;AAAAA,QAAAA,GAAUE,KAAKC,SAAY;AAAA,MAAA,GAEzFC,KAAiB,IAAIC,EAAAA;AAG3BV,MAAAA,GAAK,WAAW,WAAWS,GAAeE,MAAAA,CAAAA,GAC1CN,GAAUE,KAAK,EAAE,cAAa,oBAAIK,QAAOC,WAAW5B,OAAS,SAAA,CAAA,GAE7DJ,GAAYiC,iBAAiB,qBAAqB9B,KAClDH,GAAYiC,iBAAiB,sBAAsB9B,EAC3D;AAAA,IAAA,MACQ+B,SAAQC,KAAK,8BAAA;AAAA,EACd;AAGJ;AAxED5C,cAFWF,GAEXE,cAAoB,EAClBI,aAAa,EACXyC,MAAMC,QACNC,WAAW,kBAEb5C,QAAQ,EACN0C,MAAMG,QAIVhD,EAAAA;AAAAA,cAZWF,GAYXE,UAAgB,CACdiD,IAAMC,iDAGR,CAAA,EAAA;AA6DG5C,OAAO6C,eAAeC,IAAI,SAAA,KAC7B9C,OAAO6C,eAAeE,OAAO,WAAWvD,CAG1CwD,GAAAA,EAAe,OAAO,CAAE;"}