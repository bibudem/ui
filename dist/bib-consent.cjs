/**
 * Librairie du system desing des Bibliothèques de l'Université de Montréal
 * @module @bibudem/ui
 * @version 1.2.0
 * @author Christian Rémillard <christian.remillard@umontreal.ca>
 * @license ISC
 * @see https://github.com/bibudem/ui
 */
var t,e,s,n,o,i,r,c,a,l,h,u,p,b,d=Object.defineProperty,v=t=>{throw TypeError(t)},f=(t,e,s)=>((t,e,s)=>e in t?d(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s),g=(t,e,s)=>e.has(t)||v("Cannot "+s),y=(t,e,s)=>(g(t,e,"read from private field"),s?s.call(t):e.get(t)),E=(t,e,s)=>e.has(t)?v("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),T=(t,e,s,n)=>(g(t,e,"write to private field"),n?n.call(t,s):e.set(t,s),s),j=(t,e,s)=>(g(t,e,"access private method"),s);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const w=require("./lit-element-BHNMc-Kg.cjs"),x=require("./ref-mxufyLY8.cjs"),m=require("./bib-consent-preferences-dialog-BqYn5DOh.cjs"),C=require("./logger-B7-dxIEz.cjs"),S=require("./bib-FUdqwbg3.cjs"),k=require("./events-DuQfPugX.cjs"),O=require("./ConsentTokens.cjs"),_=require("./consentClient.cjs"),q=require("./consent-context.cjs");require("./bib-button-close.cjs"),require("./bib-consent-consent-dialog.cjs");const R=require("./constants2.cjs");
/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */let N=class{get value(){return this.o}set value(t){this.setValue(t)}setValue(t,e=!1){const s=e||!Object.is(t,this.o);this.o=t,s&&this.updateObservers()}constructor(t){this.subscriptions=new Map,this.updateObservers=()=>{for(const[t,{disposer:e}]of this.subscriptions)t(this.o,e)},void 0!==t&&(this.value=t)}addCallback(t,e,s){if(!s)return void t(this.value);this.subscriptions.has(t)||this.subscriptions.set(t,{disposer:()=>{this.subscriptions.delete(t)},consumerHost:e});const{disposer:n}=this.subscriptions.get(t);t(this.value,n)}clearCallbacks(){this.subscriptions.clear()}},A=class extends Event{constructor(t){super("context-provider",{bubbles:!0,composed:!0}),this.context=t}},M=class extends N{constructor(t,e,s){super(void 0!==e.context?e.initialValue:s),this.onContextRequest=t=>{const e=t.composedPath()[0];t.context===this.context&&e!==this.host&&(t.stopPropagation(),this.addCallback(t.callback,e,t.subscribe))},this.onProviderRequest=t=>{const e=t.composedPath()[0];if(t.context!==this.context||e===this.host)return;const s=new Set;for(const[n,{consumerHost:o}]of this.subscriptions)s.has(n)||(s.add(n),o.dispatchEvent(new m.s(this.context,n,!0)));t.stopPropagation()},this.host=t,void 0!==e.context?this.context=e.context:this.context=e,this.attachListeners(),this.host.addController?.(this)}attachListeners(){this.host.addEventListener("context-request",this.onContextRequest),this.host.addEventListener("context-provider",this.onProviderRequest)}hostConnected(){this.host.dispatchEvent(new A(this.context))}};
/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
/**
 * Librairie du system desing des Bibliothèques de l'Université de Montréal
 * @module @bibudem/ui
 * @version 1.1.1
 * @author Christian Rémillard <christian.remillard@umontreal.ca>
 * @license ISC
 * @see https://github.com/bibudem/ui
 */var P="object"==typeof global&&global&&global.Object===Object&&global,D="object"==typeof self&&self&&self.Object===Object&&self,$=P||D||Function("return this")(),V=$.Symbol,U=Object.prototype,L=U.hasOwnProperty,F=U.toString,W=V?V.toStringTag:void 0,B=Object.prototype.toString,I=V?V.toStringTag:void 0;function G(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":I&&I in Object(t)?function(t){var e=L.call(t,W),s=t[W];try{t[W]=void 0;var n=!0}catch(i){}var o=F.call(t);return n&&(e?t[W]=s:delete t[W]),o}(t):(e=t,B.call(e));var e}function H(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}
/**
 * Librairie du system desing des Bibliothèques de l'Université de Montréal
 * @module @bibudem/ui
 * @version 1.1.1
 * @author Christian Rémillard <christian.remillard@umontreal.ca>
 * @license ISC
 * @see https://github.com/bibudem/ui
 */var Y,Q=$["__core-js_shared__"],z=(Y=/[^.]+$/.exec(Q&&Q.keys&&Q.keys.IE_PROTO||""))?"Symbol(src)_1."+Y:"",J=Function.prototype.toString,K=/^\[object .+?Constructor\]$/,X=Function.prototype,Z=Object.prototype,tt=X.toString,et=Z.hasOwnProperty,st=RegExp("^"+tt.call(et).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function nt(t,e){var s,n,o=null==(s=t)?void 0:s[e];return H(n=o)&&(!z||!(z in n))&&(function(t){if(!H(t))return!1;var e=G(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e}(n)?st:K).test(function(t){if(null!=t){try{return J.call(t)}catch(e){}try{return t+""}catch(e){}}return""}(n))?o:void 0}var ot,it,rt=Object.prototype;rt.hasOwnProperty,rt.propertyIsEnumerable,null!=(it=ot=function(){return arguments}())&&"object"==typeof it&&G(ot);var ct="object"==typeof exports&&exports&&!exports.nodeType&&exports,at=ct&&"object"==typeof module&&module&&!module.nodeType&&module,lt=at&&at.exports===ct?$.Buffer:void 0;lt&&lt.isBuffer;var ht="object"==typeof exports&&exports&&!exports.nodeType&&exports,ut=ht&&"object"==typeof module&&module&&!module.nodeType&&module,pt=ut&&ut.exports===ht&&P.process,bt=function(){try{return ut&&ut.require&&ut.require("util").types||pt&&pt.binding&&pt.binding("util")}catch(it){}}();bt&&bt.isTypedArray,nt(Object,"create"),nt($,"Map"),$.Uint8Array;const dt=C.loggerFactory("bib-consent","#cd5300");class vt extends w.s{constructor(){super(),E(this,r),f(this,"_consentClient"),E(this,t),E(this,e),E(this,s),E(this,n,R.CONSENT_STATES.INDETERMINATE),E(this,o),E(this,i),this.open=!1,this.currentDialog=null,T(this,o,x.e()),T(this,i,x.e()),T(this,e,new M(this,{context:q.consentContext,initialValue:new O.ConsentTokens})),T(this,s,new m.s$1(this,{context:q.consentContext,callback:this.savePreferences}))}get state(){return y(this,n)}async connectedCallback(){super.connectedCallback(),this.debug=this.debug||!1,this.serverUrl=this.serverUrl||R.SERVER_DEFAULT_URL,this.serverRequestTimeout=this.serverRequestTimeout||R.SERVER_REQUEST_DEFAULT_TIMEOUT,this._consentClient=await _({host:this,serverUrl:this.serverUrl,serverRequestTimeout:this.serverRequestTimeout,reflectEvents:!0}),this._consentClient.addEventListener(R.EVENT_NAMES.READY,(t=>{const{detail:e}=t;e.getState()===R.CONSENT_STATES.DETERMINATE?j(this,r,a).call(this,e):j(this,r,u).call(this,"consent"),j(this,r,c).call(this,R.EVENT_NAMES.READY,{...e.toObject(),a:"allo"})}))}close(){j(this,r,h).call(this)}show(){j(this,r,u).call(this,"consent")}showPreferences(){j(this,r,u).call(this,"preferences")}async getTokens(){return T(this,t,await this._consentClient.getConsentTokens()),y(this,t).toObject()}async saveTokens(t){j(this,r,l).call(this,"[save] tokens: ",t);const e=O.ConsentTokens.from(t);try{return await this._consentClient.setConsentTokens(e),j(this,r,a).call(this,e),!0}catch(s){throw console.error("[savePreferences] error: ",s),s}}async resetTokens(){await this._consentClient.resetTokens();const e=await this._consentClient.getConsentTokens();return T(this,t,e),j(this,r,c).call(this,R.EVENT_NAMES.CHANGE,e.toObject()),e}render(){return w.x`<bib-consent-consent-dialog @intern:change="${j(this,r,p)}" @intern:show-preferences="${()=>j(this,r,u).call(this,"preferences")}" ${x.n(y(this,o))} @intern:close="${j(this,r,b)}"></bib-consent-consent-dialog><bib-consent-preferences-dialog @intern:change="${j(this,r,p)}" ${x.n(y(this,i))} @intern:close="${j(this,r,b)}"></bib-consent-preferences-dialog>`}}t=new WeakMap,e=new WeakMap,s=new WeakMap,n=new WeakMap,o=new WeakMap,i=new WeakMap,r=new WeakSet,c=function(t,e=null){k.dispatchPublicEvent(this,t,{detail:e})},a=function(t){y(this,e).setValue(t),T(this,n,y(this,e).value.getState())},l=function(){this.debug&&dt(...arguments)},h=function(t=!0){this.open=!1,this.currentDialog?.close(t),this.currentDialog=null,t&&j(this,r,c).call(this,R.EVENT_NAMES.CLOSE)},u=function(t="consent"){const e=["consent","preferences"];if("string"!=typeof t&&!e.includes(t))throw new TypeError(`The panel argument must be a string of either values \`${e.join(" or ")}\`. You provided \`${t}\``,t);this.open=!0,this.currentDialog&&(j(this,r,l).call(this,"[#show] this.currentDialog",this.currentDialog),this.currentDialog.close()),j(this,r,l).call(this,"[show]",y(this,o).value),j(this,r,l).call(this,"[show]",y(this,i).value),this.currentDialog="consent"===t?y(this,o).value:y(this,i).value,this.currentDialog.show()},p=async function(t){if(!(await this.saveTokens(t.detail)))return;const e=await this.getTokens();j(this,r,c).call(this,R.EVENT_NAMES.CHANGE,e),j(this,r,h).call(this)},b=function(t){j(this,r,h).call(this,!1)},f(vt,"properties",{serverUrl:{type:String,attribute:"server-url"},serverRequestTimeout:{type:Number,attribute:"server-request-timeout"},[R.SERVER_MODE.LOCAL]:{type:Boolean},state:{type:String},debug:{type:Boolean,reflect:!0},open:{type:Boolean,reflect:!0}}),window.customElements.get("bib-consent")||window.customElements.define("bib-consent",vt),S.addToGlobalBib("consent",{}),exports.BibConsent=vt;
//# sourceMappingURL=bib-consent.cjs.map
