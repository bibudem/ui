/**
 * Librairie du system desing des Bibliothèques de l'Université de Montréal
 * @module @bibudem/ui
 * @version 1.3.1
 * @author Christian Rémillard <christian.remillard@umontreal.ca>
 * @license ISC
 * @see https://github.com/bibudem/ui
 */
var t,e,s,n,i,o,r,c,a,h,l,u,d,p,b,v=Object.defineProperty,E=t=>{throw TypeError(t)},g=(t,e,s)=>((t,e,s)=>e in t?v(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s),T=(t,e,s)=>e.has(t)||E("Cannot "+s),f=(t,e,s)=>(T(t,e,"read from private field"),s?s.call(t):e.get(t)),w=(t,e,s)=>e.has(t)?E("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),C=(t,e,s,n)=>(T(t,e,"write to private field"),n?n.call(t,s):e.set(t,s),s),k=(t,e,s)=>(T(t,e,"access private method"),s);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const m=require("./lit-element-BHNMc-Kg.cjs"),x=require("./ref-mxufyLY8.cjs"),S=require("./bib-consent-preferences-dialog-BqYn5DOh.cjs"),q=require("./logger-BXGZV0ek.cjs"),y=require("./bib-mdcNW8yu.cjs"),R=require("./events-DuQfPugX.cjs"),N=require("./ConsentTokens.cjs"),_=require("./consentClient.cjs"),j=require("./consent-context.cjs");require("./bib-button-close.cjs"),require("./bib-consent-consent-dialog.cjs");const M=require("./constants2.cjs");
/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */class A{get value(){return this.o}set value(t){this.setValue(t)}setValue(t,e=!1){const s=e||!Object.is(t,this.o);this.o=t,s&&this.updateObservers()}constructor(t){this.subscriptions=new Map,this.updateObservers=()=>{for(const[t,{disposer:e}]of this.subscriptions)t(this.o,e)},void 0!==t&&(this.value=t)}addCallback(t,e,s){if(!s)return void t(this.value);this.subscriptions.has(t)||this.subscriptions.set(t,{disposer:()=>{this.subscriptions.delete(t)},consumerHost:e});const{disposer:n}=this.subscriptions.get(t);t(this.value,n)}clearCallbacks(){this.subscriptions.clear()}}
/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */class D extends Event{constructor(t){super("context-provider",{bubbles:!0,composed:!0}),this.context=t}}class O extends A{constructor(t,e,s){super(void 0!==e.context?e.initialValue:s),this.onContextRequest=t=>{const e=t.composedPath()[0];t.context===this.context&&e!==this.host&&(t.stopPropagation(),this.addCallback(t.callback,e,t.subscribe))},this.onProviderRequest=t=>{const e=t.composedPath()[0];if(t.context!==this.context||e===this.host)return;const s=new Set;for(const[n,{consumerHost:i}]of this.subscriptions)s.has(n)||(s.add(n),i.dispatchEvent(new S.s(this.context,n,!0)));t.stopPropagation()},this.host=t,void 0!==e.context?this.context=e.context:this.context=e,this.attachListeners(),this.host.addController?.(this)}attachListeners(){this.host.addEventListener("context-request",this.onContextRequest),this.host.addEventListener("context-provider",this.onProviderRequest)}hostConnected(){this.host.dispatchEvent(new D(this.context))}}class V extends m.s{constructor(){super(),w(this,c),w(this,t,q.loggerFactory("bib-consent","#cd5300")),g(this,"_consentClient"),w(this,e),w(this,s),w(this,n),w(this,i,M.CONSENT_STATES.INDETERMINATE),w(this,o),w(this,r),this.open=!1,this.currentDialog=null,C(this,o,x.e()),C(this,r,x.e()),C(this,s,new O(this,{context:j.consentContext,initialValue:new N.ConsentTokens})),C(this,n,new S.s$1(this,{context:j.consentContext,callback:this.savePreferences}))}get state(){return f(this,i)}async connectedCallback(){super.connectedCallback(),this.debug=this.debug||!1,this.serverUrl=this.serverUrl||M.SERVER_DEFAULT_URL,this.serverRequestTimeout=this.serverRequestTimeout||M.SERVER_REQUEST_DEFAULT_TIMEOUT,this._consentClient=await _({host:this,serverUrl:this.serverUrl,serverRequestTimeout:this.serverRequestTimeout,reflectEvents:!0}),this._consentClient.addEventListener(M.EVENT_NAMES.READY,(t=>{const{detail:e}=t;e.getState()===M.CONSENT_STATES.DETERMINATE?k(this,c,h).call(this,e):k(this,c,d).call(this,"consent"),k(this,c,a).call(this,M.EVENT_NAMES.READY,e.toObject())}))}close(){k(this,c,u).call(this)}show(){k(this,c,d).call(this,"consent")}showPreferences(){k(this,c,d).call(this,"preferences")}async getTokens(){return C(this,e,await this._consentClient.getConsentTokens()),f(this,e).toObject()}async saveTokens(t){k(this,c,l).call(this,"[save] tokens: ",t);const e=N.ConsentTokens.from(t);try{return await this._consentClient.setConsentTokens(e),k(this,c,h).call(this,e),!0}catch(s){throw console.error("[savePreferences] error: ",s),s}}async resetTokens(){await this._consentClient.resetTokens();const t=await this._consentClient.getConsentTokens();return C(this,e,t),k(this,c,a).call(this,M.EVENT_NAMES.CHANGE,t.toObject()),t}render(){return m.x`<bib-consent-consent-dialog @intern:change="${k(this,c,p)}" @intern:show-preferences="${()=>k(this,c,d).call(this,"preferences")}" ${x.n(f(this,o))} @intern:close="${k(this,c,b)}"></bib-consent-consent-dialog><bib-consent-preferences-dialog @intern:change="${k(this,c,p)}" ${x.n(f(this,r))} @intern:close="${k(this,c,b)}"></bib-consent-preferences-dialog>`}}t=new WeakMap,e=new WeakMap,s=new WeakMap,n=new WeakMap,i=new WeakMap,o=new WeakMap,r=new WeakMap,c=new WeakSet,a=function(t,e=null){R.dispatchPublicEvent(this,t,{detail:e})},h=function(t){f(this,s).setValue(t),C(this,i,f(this,s).value.getState())},l=function(){this.debug&&f(this,t).call(this,...arguments)},u=function(t=!0){this.open=!1,this.currentDialog?.close(t),this.currentDialog=null,t&&k(this,c,a).call(this,M.EVENT_NAMES.CLOSE)},d=function(t="consent"){const e=["consent","preferences"];if("string"!=typeof t&&!e.includes(t))throw new TypeError(`The panel argument must be a string of either values \`${e.join(" or ")}\`. You provided \`${t}\``,t);this.open=!0,this.currentDialog&&(k(this,c,l).call(this,"[#show] this.currentDialog",this.currentDialog),this.currentDialog.close()),k(this,c,l).call(this,"[show]",f(this,o).value),k(this,c,l).call(this,"[show]",f(this,r).value),this.currentDialog="consent"===t?f(this,o).value:f(this,r).value,this.currentDialog.show()},p=async function(t){if(!(await this.saveTokens(t.detail)))return;const e=await this.getTokens();k(this,c,a).call(this,M.EVENT_NAMES.CHANGE,e),k(this,c,u).call(this)},b=function(t){k(this,c,u).call(this,!1)},g(V,"properties",{serverUrl:{type:String,attribute:"server-url"},serverRequestTimeout:{type:Number,attribute:"server-request-timeout"},[M.SERVER_MODE.LOCAL]:{type:Boolean},state:{type:String},debug:{type:Boolean,reflect:!0},open:{type:Boolean,reflect:!0}}),window.customElements.get("bib-consent")||window.customElements.define("bib-consent",V),y.addToGlobalBib("consent",{}),exports.BibConsent=V;
//# sourceMappingURL=bib-consent.cjs.map
