{"version":3,"file":"bib-avis.js","sources":["../src/components/bib-avis/bib-avis.js","../src/icons/close_FILL0_wght400_GRAD0_opsz24.svg?raw","../src/utils/dom.js"],"sourcesContent":["import { Task } from '@lit/task'\r\nimport { LitElement, html, css, unsafeCSS } from 'lit'\r\nimport { unsafeHTML } from 'lit/directives/unsafe-html.js'\r\nimport { openDB } from 'idb'\r\nimport { nodeIsEmpty } from '@/utils/dom.js'\r\nimport { addToGlobalBib } from '@/utils/bib.js'\r\nimport { DB_NAME, DB_STORE_NAME, DB_VERSION } from './constants.js'\r\nimport closeIcon from '../../icons/close_FILL0_wght400_GRAD0_opsz24.svg?raw'\r\nimport bibAvisStyles from './bib-avis.scss?inline'\r\n\r\n/**\r\n * Génère un hash SHA-256 pour un objet donné\r\n * @param {Object} obj - L'objet à hasher\r\n * @returns {Promise<string>} Le hash hexadécimal de l'objet\r\n */\r\nasync function hash(obj) {\r\n  const utf8 = new TextEncoder().encode(JSON.stringify(obj))\r\n  const hashBuffer = await crypto.subtle.digest('SHA-256', utf8)\r\n  const hashArray = Array.from(new Uint8Array(hashBuffer))\r\n  const hashHex = hashArray\r\n    .map((bytes) => bytes.toString(16).padStart(2, '0'))\r\n    .join('')\r\n  return hashHex\r\n}\r\n\r\n/**\r\n * Composant d'affichage d'avis pour les Bibliothèques de l'Université de Montréal\r\n * \r\n * Ce composant Web personnalisé permet d'afficher des avis provenant d'un service distant\r\n * ou du contenu local. Il gère la persistance des avis via IndexedDB pour éviter\r\n * d'afficher plusieurs fois le même avis à l'utilisateur.\r\n * \r\n * @element bib-avis\r\n * \r\n * @fires bib:show - Émis avant l'affichage d'un avis. Peut être annulé.\r\n * @fires bib:hide - Émis avant le masquage d'un avis. Peut être annulé.\r\n * \r\n * @slot - Contenu HTML local à afficher comme avis (optionnel)\r\n * \r\n * @example\r\n * \r\n * <!-- Avis depuis un service distant -->\r\n * <bib-avis service=\"https://avis.bib.umontreal.ca/api/avis\" bouton-fermer></bib-avis>\r\n * \r\n * <!-- Avis avec contenu local -->\r\n * <bib-avis bouton-fermer>\r\n *   <p>Ceci est un avis local important.</p>\r\n * </bib-avis>\r\n * \r\n * \r\n * @cssprop --bib-avis-background-color - Couleur de fond de l'avis\r\n * @cssprop --bib-avis-text-color - Couleur du texte de l'avis\r\n * @cssprop --bib-avis-border-color - Couleur de la bordure de l'avis\r\n */\r\nexport class BibAvis extends LitElement {\r\n  /**\r\n   * Propriétés réactives du composant\r\n   */\r\n  static properties = {\r\n    /**\r\n     * URL du service d'avis distant\r\n     * @type {string}\r\n     * @default 'https://avis.bib.umontreal.ca/api/avis'\r\n     */\r\n    service: {\r\n      type: String\r\n    },\r\n    /**\r\n     * Affiche ou masque le bouton de fermeture\r\n     * @type {boolean}\r\n     * @default false\r\n     */\r\n    boutonFermer: {\r\n      type: Boolean,\r\n      attribute: 'bouton-fermer'\r\n    },\r\n    /**\r\n     * Message d'avis actuel (état interne)\r\n     * @type {Object|null}\r\n     * @private\r\n     */\r\n    message: {\r\n      state: true\r\n    }\r\n  }\r\n\r\n  static styles = [\r\n    css`${unsafeCSS(bibAvisStyles)}`,\r\n    css`\r\n    `\r\n  ]\r\n\r\n  /**\r\n   * Données de l'avis actuel\r\n   * @type {Object|null}\r\n   * @private\r\n   */\r\n  #avis\r\n\r\n  /**\r\n   * Instance de la base de données IndexedDB\r\n   * @type {IDBDatabase|null}\r\n   * @private\r\n   */\r\n  #db\r\n\r\n  /**\r\n   * Constructeur du composant BibAvis\r\n   * Initialise les propriétés par défaut\r\n   */\r\n  constructor() {\r\n    super()\r\n\r\n    this.#avis = null\r\n    this.service = 'https://avis.bib.umontreal.ca/api/avis'\r\n    this.boutonFermer = false\r\n  }\r\n\r\n  /**\r\n   * Crée et retourne une tâche pour récupérer les avis\r\n   * @returns {Task} Tâche de récupération des avis\r\n   * @private\r\n   */\r\n  #getAvis() {\r\n    return new Task(this, {\r\n      task: async ([service], { signal }) => {\r\n\r\n        const doGetAvis = new Promise(async (resolve, reject) => {\r\n          if (!nodeIsEmpty(this)) {\r\n            return resolve({ isLocal: true, message: this.innerHTML.split(/<!--\\?lit\\$\\d+\\$-->/).join('') })\r\n          }\r\n\r\n          const url = new URL(service)\r\n          const response = await fetch(url, {\r\n            headers: {\r\n              \"Accept\": \"application/json\",\r\n            },\r\n            signal\r\n          })\r\n            .catch(console.error)\r\n\r\n          if (!response.ok) {\r\n            return reject(new Error(response.status))\r\n          }\r\n\r\n          const { success, data } = await response.json()\r\n\r\n          if (success) {\r\n            if (data === null) {\r\n            return resolve({ isLocal: false, message: null })\r\n          }\r\n            const { id, message } = data\r\n            return resolve({ isLocal: false, id, message })\r\n          }\r\n\r\n          reject(new Error('The service responded with a message with a prop succes at', success))\r\n        })\r\n\r\n        try {\r\n          const data = await doGetAvis\r\n          await this.#processAvis(data)\r\n        } catch (error) {\r\n          console.error('[#getAvis] An error occured: %o', error)\r\n        }\r\n\r\n        return data\r\n      },\r\n      args: () => [this.service]\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Traite les données d'avis récupérées et gère la persistance\r\n   * @param {Object} avis - Données de l'avis à traiter\r\n   * @param {string} avis.message - Contenu HTML du message\r\n   * @param {string} [avis.id] - Id unique du message\r\n   * @param {boolean} [avis.isLocal] - Indique si l'avis provient du contenu local\r\n   * @returns {Promise<void>}\r\n   * @private\r\n   */\r\n  async #processAvis(avis) {\r\n    // Vérifier si avis est null ou n'a pas de message\r\n    if (!avis || !avis.message) {\r\n      this.setMessage(null)\r\n      return\r\n    }\r\n    const { id, message } = avis\r\n    if (!message) {\r\n      this.setMessage(null)\r\n      return\r\n    }\r\n\r\n    if (!('indexedDB' in window)) {\r\n      this.setMessage(message)\r\n      return\r\n    }\r\n\r\n    const db = this.#db = await openDB(DB_NAME, DB_VERSION, {\r\n      upgrade(db) {\r\n        // Checks if the object store exists:\r\n        if (!db.objectStoreNames.contains(DB_STORE_NAME)) {\r\n          db.createObjectStore(DB_STORE_NAME)\r\n        }\r\n      }\r\n    })\r\n\r\n    try {\r\n    // Vérifier que id existe avant de l'utiliser\r\n    const storageId = id || await hash(avis)\r\n    \r\n    const storedAvis = await db.get(DB_STORE_NAME, storageId)\r\n    if (storedAvis) {\r\n      if (!storedAvis.hidden) {\r\n        // Utiliser storageId au lieu de id\r\n        await db.delete(DB_STORE_NAME, storageId)\r\n        this.#show({...storedAvis, id: storageId})\r\n      }\r\n    } else {\r\n      this.#show({...avis, id: storageId})\r\n    }\r\n  } catch (error) {\r\n    console.error('Something went wrong with indexedDB: %o', error)\r\n    this.setMessage(message)\r\n  }\r\n  }\r\n\r\n  /**\r\n   * Affiche l'avis et le sauvegarde en base de données\r\n   * @param {Object} avis - Données de l'avis à afficher\r\n   * @returns {Promise<void>}\r\n   * @private\r\n   */\r\n  async #show(message) {\r\n  const canceled = !this.dispatchEvent(new CustomEvent('bib:show', { bubbles: true, cancelable: true }))\r\n\r\n  if (canceled) {\r\n    return\r\n  }\r\n\r\n  this.setMessage(message)\r\n\r\n  // Vérifier que message.id existe avant de l'utiliser\r\n  if (this.#db && message.id) {\r\n    await this.#db.put(DB_STORE_NAME, { ...message, hidden: false }, message.id)\r\n  }\r\n}\r\n\r\n  /**\r\n   * Masque l'avis et met à jour son statut en base de données\r\n   * @returns {Promise<void>}\r\n   * @private\r\n   */\r\n  async #hide() {\r\n\r\n    const canceled = !this.dispatchEvent(new CustomEvent('bib:hide', { bubbles: true, cancelable: true }))\r\n\r\n    if (canceled) {\r\n      return\r\n    }\r\n\r\n    const { id } = this.#avis\r\n    await this.#db.put(DB_STORE_NAME, { ...this.#avis, hidden: true }, id)\r\n    this.#avis = null\r\n    this.requestUpdate()\r\n  }\r\n\r\n  /**\r\n   * Méthode du cycle de vie appelée lorsque l'élément est connecté au DOM\r\n   * Initialise la récupération des avis\r\n   */\r\n  connectedCallback() {\r\n    super.connectedCallback()\r\n    this.#getAvis()\r\n  }\r\n\r\n  /**\r\n   * Gestionnaire de clic pour le bouton de fermeture\r\n   * @private\r\n   */\r\n  #onBtnFermerClick() {\r\n    this.#hide()\r\n  }\r\n\r\n  /**\r\n   * Rendu conditionnel du bouton de fermeture\r\n   * @returns {TemplateResult|null} Template du bouton ou null\r\n   * @private\r\n   */\r\n  _renderBoutonFermer() {\r\n    return this.boutonFermer ? html`<button class=\"btn-close\" aria-label=\"Fermer\" @click=\"${this.#onBtnFermerClick}\">${unsafeHTML(closeIcon)}</button>` : null\r\n  }\r\n\r\n  /**\r\n   * Méthode de rendu du composant\r\n   * @returns {TemplateResult|null} Template HTML de l'avis ou null si aucun message\r\n   */\r\n  render() {\r\n    return this.#avis?.message ? html`<aside class=\"container\"><div class=\"inner\"><div class=\"message\">${unsafeHTML(this.#avis.message)}</div>${this._renderBoutonFermer()}</div></aside>` : null\r\n  }\r\n\r\n  /**\r\n   * Définit le message d'avis à afficher\r\n   * @param {string|Object|null} message - Message à afficher ou objet contenant le message\r\n   * @public\r\n   */\r\n  setMessage(message) {\r\n    this.#avis = typeof message === 'string' ? { message, isLocal: true } : message\r\n  }\r\n}\r\n\r\nif (!window.customElements.get('bib-avis')) {\r\n  window.customElements.define('bib-avis', BibAvis)\r\n}\r\n\r\naddToGlobalBib('avis', {})","export default \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" height=\\\"24\\\" viewBox=\\\"0 -960 960 960\\\" width=\\\"24\\\"><path d=\\\"M480-424 284-228q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536-480l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480-424Z\\\"/></svg>\"","export function nodeIsEmpty(node) {\r\n  return node.textContent.trim() === \"\"\r\n}"],"names":["BibAvis","LitElement","super","this","avis","db","service","boutonFermer","connectedCallback","html","unsafeHTML","message","_renderBoutonFermer","isLocal","getAvis","Task","task","async","signal","doGetAvis","Promise","resolve","reject","textContent","trim","innerHTML","split","join","url","URL","response","fetch","headers","Accept","catch","console","error","ok","Error","status","success","data","json","id","args","processAvis","setMessage","window","openDB","DB_NAME","DB_VERSION","objectStoreNames","contains","DB_STORE_NAME","createObjectStore","storageId","obj","utf8","TextEncoder","encode","JSON","stringify","hashBuffer","crypto","subtle","digest","Array","from","Uint8Array","map","bytes","toString","padStart","storedAvis","get","hidden","delete","show","dispatchEvent","CustomEvent","bubbles","cancelable","put","hide","requestUpdate","onBtnFermerClick","static","type","String","Boolean","attribute","state","css","unsafeCSS","customElements","define","addToGlobalBib"],"mappings":"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"}