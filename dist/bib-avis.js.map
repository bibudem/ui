{"version":3,"file":"bib-avis.js","sources":["../src/components/bib-avis/bib-avis.js","../src/icons/close_FILL0_wght400_GRAD0_opsz24.svg?raw","../src/utils/dom.js"],"sourcesContent":["import { Task } from '@lit/task'\nimport { LitElement, html, css, unsafeCSS } from 'lit'\nimport { unsafeHTML } from 'lit/directives/unsafe-html.js'\nimport { openDB } from 'idb'\nimport { nodeIsEmpty } from '@/utils/dom.js'\nimport { addToGlobalBib } from '@/utils/bib.js'\nimport { DB_NAME, DB_STORE_NAME, DB_VERSION } from './constants.js'\nimport closeIcon from '../../icons/close_FILL0_wght400_GRAD0_opsz24.svg?raw'\nimport bibAvisStyles from './bib-avis.scss?inline'\n\nasync function hash(obj) {\n  const utf8 = new TextEncoder().encode(JSON.stringify(obj))\n  const hashBuffer = await crypto.subtle.digest('SHA-256', utf8)\n  const hashArray = Array.from(new Uint8Array(hashBuffer))\n  const hashHex = hashArray\n    .map((bytes) => bytes.toString(16).padStart(2, '0'))\n    .join('')\n  return hashHex\n}\n\n/**\n * Un avis\n * Affiche un avis\n */\nexport class BibAvis extends LitElement {\n  static properties = {\n    service: {\n      type: String\n    },\n    contexte: {\n      type: String,\n      default: 'site-web'\n    },\n    niveau: {\n      type: String\n    },\n    boutonFermer: {\n      type: Boolean,\n      attribute: 'bouton-fermer'\n    },\n    message: {\n      state: true\n    }\n  }\n\n  static styles = [\n    css`${unsafeCSS(bibAvisStyles)}`,\n    css`\n    `\n  ]\n\n  #avis\n  #db\n\n  constructor() {\n    super()\n\n    this.#avis = null\n    this.service = 'https://avis.bib.umontreal.ca'\n    this.contexte = 'site-web-dev'\n    this.niveau = 'important'\n    this.boutonFermer = false\n  }\n\n  #getAvis() {\n    return new Task(this, {\n      task: async ([service, contexte, niveau], { signal }) => {\n\n        const doGetAvis = new Promise(async (resolve, reject) => {\n          if (!nodeIsEmpty(this)) {\n            return resolve({ isLocal: true, message: this.innerHTML.split(/<!--\\?lit\\$\\d+\\$-->/).join('') })\n          }\n\n          const url = new URL(`${contexte}/${niveau}`, service)\n          const response = await fetch(url, {\n            headers: {\n              \"Accept\": \"application/json\",\n            },\n            signal\n          })\n\n          if (!response.ok) {\n            return reject(new Error(response.status))\n          }\n\n          const { message } = await response.json()\n\n          resolve({ isLocal: false, message })\n        })\n\n        try {\n          const data = await doGetAvis\n          await this.#processAvis(data)\n        } catch (error) {\n          console.error('[#getAvis] An error occured: %o', error)\n        }\n\n        return data\n      },\n      args: () => [this.service, this.contexte, this.niveau]\n    })\n  }\n\n  async #processAvis(avis) {\n    if (!avis.message) {\n      this.setMessage(null)\n      return\n    }\n\n    if (!('indexedDB' in window)) {\n      this.setMessage(avis.message)\n      return\n    }\n\n    const db = this.#db = await openDB(DB_NAME, DB_VERSION, {\n      upgrade(db) {\n        // Checks if the object store exists:\n        if (!db.objectStoreNames.contains(DB_STORE_NAME)) {\n          db.createObjectStore(DB_STORE_NAME)\n        }\n      }\n    })\n\n    try {\n      const id = await hash(avis)\n      const storedAvis = await db.get(DB_STORE_NAME, id)\n      if (storedAvis) {\n        if (!storedAvis.hidden) {\n          // Delete old entries\n          await db.delete(DB_STORE_NAME, id)\n          this.#show(storedAvis)\n        }\n      } else {\n        this.#show(avis)\n      }\n    } catch (error) {\n      console.error('Something went wrong with indexedDB: %o', error)\n      this.setMessage(avis.message)\n    }\n  }\n\n  async #show(avis) {\n\n    const canceled = !this.dispatchEvent(new CustomEvent('bib:show', { bubbles: true, cancelable: true }))\n\n    if (canceled) {\n      return\n    }\n\n    this.setMessage(avis)\n\n    if (this.#db) {\n      const id = await hash(avis)\n      await this.#db.put(DB_STORE_NAME, { ...avis, hidden: false }, id)\n    }\n  }\n\n  async #hide() {\n\n    const canceled = !this.dispatchEvent(new CustomEvent('bib:hide', { bubbles: true, cancelable: true }))\n\n    if (canceled) {\n      return\n    }\n\n    const id = await hash(this.#avis)\n    await this.#db.put(DB_STORE_NAME, { ...this.#avis, hidden: true }, id)\n    this.#avis = null\n    this.requestUpdate()\n  }\n\n  connectedCallback() {\n    super.connectedCallback()\n    this.#getAvis()\n  }\n\n  #onBtnFermerClick() {\n    this.#hide()\n  }\n\n  _renderBoutonFermer() {\n    return this.boutonFermer ? html`<button class=\"btn-close\" aria-label=\"Fermer\" @click=\"${this.#onBtnFermerClick}\">${unsafeHTML(closeIcon)}</button>` : null\n  }\n\n  _avisTask = new Task(this, {\n    task: async ([service, contexte, niveau], { signal }) => {\n      const url = new URL(`${contexte}/${niveau}`, service)\n      const response = await fetch(url, {\n        headers: {\n          \"Accept\": \"application/json\",\n          // 'Content-Type': 'application/x-www-form-urlencoded',\n        },\n        signal\n      })\n      if (!response.ok) {\n        throw new Error(response.status)\n      }\n      return response.json()\n    },\n    args: () => [this.service, this.contexte, this.niveau]\n  })\n\n  render() {\n    return this.#avis?.message ? html`<aside class=\"container\"><div class=\"inner\"><div class=\"message\">${unsafeHTML(this.#avis.message)}</div>${this._renderBoutonFermer()}</div></aside>` : null\n  }\n\n  setMessage(message) {\n    this.#avis = typeof message === 'string' ? { message, isLocal: true } : message\n  }\n}\n\nif (!window.customElements.get('bib-avis')) {\n  window.customElements.define('bib-avis', BibAvis)\n}\n\naddToGlobalBib('avis', {})","export default \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" height=\\\"24\\\" viewBox=\\\"0 -960 960 960\\\" width=\\\"24\\\"><path d=\\\"M480-424 284-228q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536-480l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480-424Z\\\"/></svg>\"","export function nodeIsEmpty(node) {\n  return node.textContent.trim() === \"\"\n}"],"names":["async","hash","obj","utf8","TextEncoder","encode","JSON","stringify","hashBuffer","crypto","subtle","digest","Array","from","Uint8Array","map","bytes","toString","padStart","join","BibAvis","LitElement","static","super","avis","db","_avisTask","Task","this","task","service","contexte","niveau","signal","i","url","URL","response","fetch","headers","Accept","ok","Error","status","json","args","boutonFermer","connectedCallback","getAvis","html","unsafeHTML","message","_renderBoutonFermer","isLocal","doGetAvis","Promise","resolve","reject","textContent","trim","innerHTML","split","data","processAvis","error","console","setMessage","window","openDB","DB_NAME","DB_VERSION","objectStoreNames","contains","DB_STORE_NAME","createObjectStore","id","storedAvis","get","hidden","delete","show","dispatchEvent","CustomEvent","bubbles","cancelable","put","hide","requestUpdate","onBtnFermerClick","type","String","default","Boolean","attribute","state","css","unsafeCSS","customElements","define","addToGlobalBib"],"mappings":"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"}